<script>
    // УКАЗАТЕЛЬ: Ваш URL-адрес Google Apps Script
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwf-sQ5LVhriYEh8gsDr53EDkczVnH2LCeafu_Rj07yz8V3O_5UWNzv6ghlL2Hc4TOo/exec';
    
    let isScanning = false;
    let ndefReader = null;
    let readingHandler = null;
    let registrationCount = 0; // Counter for successful registrations
    const log = document.getElementById('log');
    const statusDiv = document.getElementById('status');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');

    function getFormattedDateAndTime() {
        const now = new Date();
        
        // Разделяем дату и время, как того требует ваша таблица (Столбцы A и B)
        const date = now.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const time = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        return { date, time };
    }

    async function startScanning() {
        if (!('NDEFReader' in window)) {
            alert('WebNFC is not supported in this browser. Please use Chrome on Android.');
            return;
        }

        const trainerName = document.getElementById('trainer-name').value;
        const training = document.getElementById('training-id').value;
        
        if (!trainerName || !training) {
            alert('Please enter both Trainer\'s Name and Training');
            return;
        }

        try {
            await stopScanningInternal();
            
            isScanning = true;
            updateStatus(true);
            updateButtons(true);
            registrationCount = 0;
            
            ndefReader = new NDEFReader();
            
            readingHandler = ({ serialNumber }) => {
                if (!isScanning) return;
                
                const { date, time } = getFormattedDateAndTime();
                
                const formattedNfcId = serialNumber
                    .replace(/[^a-fA-F0-9]/g, '')
                    .toUpperCase()
                    .trim();
                
                // *** ИСПРАВЛЕНИЕ: ОТПРАВЛЯЕМ ЛОГИЧНЫЕ И РАЗДЕЛЕННЫЕ ПОЛЯ ***
                sendToServer({
                    date: date,             // Столбец A
                    time: time,             // Столбец B
                    trainerName: trainerName, // Столбец C (исправлено с deviceId)
                    trainingName: training, // Столбец D (исправлено с number)
                    nfcUid: formattedNfcId  // Столбец E (исправлено с nfcId)
                });
            };

            ndefReader.addEventListener("reading", readingHandler);
            await ndefReader.scan();
            
        } catch (error) {
            handleError(error);
        }
    }
    
    async function stopScanningInternal() {
        if (ndefReader && readingHandler) {
            try {
                // Если считыватель активен, пробуем его остановить
                ndefReader.removeEventListener("reading", readingHandler); 
            } catch (error) {
                console.error('Error removing event listener:', error);
            }
        }
        ndefReader = null;
        readingHandler = null;
        isScanning = false;
    }

    async function stopScanning() {
        await stopScanningInternal();
        updateStatus(false);
        updateButtons(false);
        addLogEntry('Scanning stopped');
    }
    
    function updateStatus(isActive) {
        statusDiv.className = `status ${isActive ? 'active' : 'inactive'}`;
        statusDiv.textContent = `Scanner ${isActive ? 'active - ready to scan' : 'inactive'}`;
    }

    function updateButtons(isScanning) {
        startButton.disabled = isScanning;
        stopButton.disabled = !isScanning;
    }
    
    function addLogEntry(message) {
        const div = document.createElement('div');
        div.className = 'scan-item';
        div.textContent = message;
        log.insertBefore(div, log.firstChild);
    }
    
    function handleError(error) {
        console.error('Error:', error);
        addLogEntry(`Registration failed: ${error.message || 'Unknown error'}`);
        stopScanningInternal();
        updateStatus(false);
        updateButtons(false);
    }
    
    async function sendToServer(data) {
        try {
            // Отправляем данные на сервер с правильными названиями полей
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            registrationCount++;
            addLogEntry(`${registrationCount}. Delegate registered successfully`);
        } catch (error) {
            handleError(error);
        }
    }

    window.addEventListener('beforeunload', stopScanningInternal);
</script>
