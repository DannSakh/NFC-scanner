<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Group Scanner</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 15px; background: #eee; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        
        h2 { margin-top: 0; text-align: center; color: #333; }
        
        button { width: 100%; padding: 16px; margin: 8px 0; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; }
        .btn-start { background: #28a745; }
        .btn-stop { background: #dc3545; display: none; }
        .btn-send { background: #007bff; display: none; }
        
        #log { margin-top: 15px; max-height: 300px; overflow-y: auto; background: #fafafa; border: 1px solid #ddd; border-radius: 8px; }
        .row { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-family: monospace; font-size: 14px; }
        .row:last-child { border-bottom: none; }
        
        .status { text-align: center; margin-bottom: 10px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

<div class="card">
    <h2>–°–∫–∞–Ω –ì—Ä—É–ø–ø—ã</h2>
    <div class="status" id="status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>

    <button id="startBtn" class="btn-start">‚ñ∂ –ù–ê–ß–ê–¢–¨ –°–ï–°–°–ò–Æ</button>
    <button id="stopBtn" class="btn-stop">‚èπ –°–¢–û–ü</button>
    
    <div id="log"></div>
    
    <button id="sendBtn" class="btn-send">‚úâ –û–¢–ü–†–ê–í–ò–¢–¨ –î–ê–ù–ù–´–ï</button>
</div>

<script>
    const SCRIPT_URL = '–¢–í–û–ô_URL_–û–¢_GOOGLE_APPS_SCRIPT'; // <--- –í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É —Å—é–¥–∞

    let ndef;
    let currentSession = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –¢–ï–ö–£–©–ï–ô –≥—Ä—É–ø–ø—ã
    let isScanning = false;

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã: dd.mm.yyyy
    function formatDate(date) {
        let d = date.getDate().toString().padStart(2, '0');
        let m = (date.getMonth() + 1).toString().padStart(2, '0');
        let y = date.getFullYear();
        return `${d}.${m}.${y}`;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏: hh:mm
    function formatTime(date) {
        let h = date.getHours().toString().padStart(2, '0');
        let m = date.getMinutes().toString().padStart(2, '0');
        return `${h}:${m}`;
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
        try {
            if (!("NDEFReader" in window)) {
                alert("–ù—É–∂–µ–Ω Android + Chrome + HTTPS");
                return;
            }
            ndef = new NDEFReader();
            await ndef.scan();
            
            isScanning = true;
            updateUI(true);
            document.getElementById('status').innerText = "üì° –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –±–µ–π–¥–∂–∏...";
            
            ndef.onreading = event => {
                const id = event.serialNumber;
                const now = new Date();
                
                // –ü—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–∫–∞–Ω–∞ (–∑–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫)
                if (currentSession.length > 0) {
                    const last = currentSession[currentSession.length - 1];
                    if (last.id === id && (now - last.rawObj) < 2000) return; 
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
                const record = {
                    date: formatDate(now),
                    time: formatTime(now),
                    id: id,
                    rawObj: now // —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
                };
                
                currentSession.push(record);
                renderRow(record);
                
                // –í–∏–±—Ä–∞—Ü–∏—è
                if (navigator.vibrate) navigator.vibrate(100);
            };

        } catch (err) {
            alert("–û—à–∏–±–∫–∞: " + err);
        }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        isScanning = false;
        updateUI(false);
        document.getElementById('status').innerText = `–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. ${currentSession.length} —á–µ–ª.`;
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
        if (currentSession.length === 0) return alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏!");

        const btn = document.getElementById('sendBtn');
        btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
        btn.disabled = true;

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ scans: currentSession })
        }).then(() => {
            alert("‚úÖ –£—à–ª–æ! –î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –Ω–∞ –ø–æ—á—Ç–µ.");
            // –°–±—Ä–æ—Å –¥–ª—è –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã
            currentSession = [];
            document.getElementById('log').innerHTML = "";
            btn.innerText = "‚úâ –û–¢–ü–†–ê–í–ò–¢–¨ –î–ê–ù–ù–´–ï";
            btn.disabled = false;
            document.getElementById('status').innerText = "–ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø–µ";
            updateUI(false); // –í–µ—Ä–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É –°—Ç–∞—Ä—Ç
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏, –ø–æ–∫–∞ –Ω–µ –Ω–∞—á–Ω–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
            document.getElementById('sendBtn').style.display = 'none'; 
        }).catch(err => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err);
            btn.disabled = false;
        });
    });

    function renderRow(rec) {
        const div = document.createElement('div');
        div.className = 'row';
        // A: Date, B: Time, C: ID
        div.innerHTML = `<span>${rec.date}</span> <span>${rec.time}</span> <span>${rec.id}</span>`;
        document.getElementById('log').prepend(div);
    }

    function updateUI(scanning) {
        document.getElementById('startBtn').style.display = scanning ? 'none' : 'block';
        document.getElementById('stopBtn').style.display = scanning ? 'block' : 'none';
        
        // –ö–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –ù–ï —Å–∫–∞–Ω–∏—Ä—É–µ–º –∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
        if (!scanning && currentSession.length > 0) {
            document.getElementById('sendBtn').style.display = 'block';
        } else {
            document.getElementById('sendBtn').style.display = 'none';
        }
    }
</script>

</body>
</html>
